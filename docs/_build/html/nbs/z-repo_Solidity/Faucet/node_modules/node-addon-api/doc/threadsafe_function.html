
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ThreadSafeFunction &#8212; Mathematics</title>
    
  <link href="../../../../../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../../../../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../../../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../../../../../" src="../../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../../_static/jquery.js"></script>
    <script src="../../../../../../_static/underscore.js"></script>
    <script src="../../../../../../_static/doctools.js"></script>
    <script src="../../../../../../_static/togglebutton.js"></script>
    <script src="../../../../../../_static/clipboard.min.js"></script>
    <script src="../../../../../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../../../../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../../../../index.html">
      
      <img src="../../../../../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Mathematics</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../../README.html">
   Mathematics
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Foundations
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../Sets.html">
   Sets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../NumberTheory.html">
   Number Theory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../AlgorithmicNumberTheory.html">
   Algorithmic Number Theory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../ModularArithmetic.html">
   Modular Arithmetic
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../Polynomials.html">
   Polynomials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../Structures.html">
   Structures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../Groups.html">
   Groups
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../Fields.html">
   Fields
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../mathematical_foundations.html">
   Imports
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Modeling
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../RandomWalks.html">
   Random Walks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../DigitalSignalProcessing.html">
   Digital Signal Processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../DifferentialEquations.html">
   Differential Equations
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Blockchain
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../PythonBlockchain.html">
   Python Blockchain
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../../../../_sources/nbs/z-repo_Solidity/Faucet/node_modules/node-addon-api/doc/threadsafe_function.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/davefriedman01/Resources"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/davefriedman01/Resources/issues/new?title=Issue%20on%20page%20%2Fnbs/z-repo_Solidity/Faucet/node_modules/node-addon-api/doc/threadsafe_function.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#methods">
   Methods
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#constructor">
     Constructor
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Constructor
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#new">
     New
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#acquire">
     Acquire
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#release">
     Release
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#abort">
     Abort
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#blockingcall-nonblockingcall">
     BlockingCall / NonBlockingCall
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example">
   Example
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="threadsafefunction">
<h1>ThreadSafeFunction<a class="headerlink" href="#threadsafefunction" title="Permalink to this headline">¶</a></h1>
<p>JavaScript functions can normally only be called from a native addon’s main
thread. If an addon creates additional threads, then node-addon-api functions
that require a <code class="docutils literal notranslate"><span class="pre">Napi::Env</span></code>, <code class="docutils literal notranslate"><span class="pre">Napi::Value</span></code>, or <code class="docutils literal notranslate"><span class="pre">Napi::Reference</span></code> must not be
called from those threads.</p>
<p>When an addon has additional threads and JavaScript functions need to be invoked
based on the processing completed by those threads, those threads must
communicate with the addon’s main thread so that the main thread can invoke the
JavaScript function on their behalf. The thread-safe function APIs provide an
easy way to do this.</p>
<p>These APIs provide the type <code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code> as well as APIs to
create, destroy, and call objects of this type.
<code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction::New()</span></code> creates a persistent reference that holds a
JavaScript function which can be called from multiple threads. The calls happen
asynchronously. This means that values with which the JavaScript callback is to
be called will be placed in a queue, and, for each value in the queue, a call
will eventually be made to the JavaScript function.</p>
<p><code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code> objects are destroyed when every thread which uses
the object has called <code class="docutils literal notranslate"><span class="pre">Release()</span></code> or has received a return status of
<code class="docutils literal notranslate"><span class="pre">napi_closing</span></code> in response to a call to <code class="docutils literal notranslate"><span class="pre">BlockingCall()</span></code> or <code class="docutils literal notranslate"><span class="pre">NonBlockingCall()</span></code>.
The queue is emptied before the <code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code> is destroyed. It is
important that <code class="docutils literal notranslate"><span class="pre">Release()</span></code> be the last API call made in conjunction with a given
<code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code>, because after the call completes, there is no
guarantee that the <code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code> is still allocated. For the same
reason it is also important that no more use be made of a thread-safe function
after receiving a return value of <code class="docutils literal notranslate"><span class="pre">napi_closing</span></code> in response to a call to
<code class="docutils literal notranslate"><span class="pre">BlockingCall()</span></code> or <code class="docutils literal notranslate"><span class="pre">NonBlockingCall()</span></code>. Data associated with the
<code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code> can be freed in its <code class="docutils literal notranslate"><span class="pre">Finalizer</span></code> callback which was
passed to <code class="docutils literal notranslate"><span class="pre">ThreadSafeFunction::New()</span></code>.</p>
<p>Once the number of threads making use of a <code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code> reaches
zero, no further threads can start making use of it by calling <code class="docutils literal notranslate"><span class="pre">Acquire()</span></code>. In
fact, all subsequent API calls associated with it, except <code class="docutils literal notranslate"><span class="pre">Release()</span></code>, will
return an error value of <code class="docutils literal notranslate"><span class="pre">napi_closing</span></code>.</p>
<div class="section" id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this headline">¶</a></h2>
<div class="section" id="constructor">
<h3>Constructor<a class="headerlink" href="#constructor" title="Permalink to this headline">¶</a></h3>
<p>Creates a new empty instance of <code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Napi</span><span class="o">::</span><span class="n">Function</span><span class="o">::</span><span class="n">ThreadSafeFunction</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3>Constructor<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Creates a new instance of the <code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code> object.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Napi</span><span class="o">::</span><span class="n">ThreadSafeFunction</span><span class="o">::</span><span class="n">ThreadSafeFunction</span><span class="p">(</span><span class="n">napi_threadsafe_function</span> <span class="n">tsfn</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tsfn</span></code>: The <code class="docutils literal notranslate"><span class="pre">napi_threadsafe_function</span></code> which is a handle for an existing
thread-safe function.</p></li>
</ul>
<p>Returns a non-empty <code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code> instance. When using this
constructor, only use the <code class="docutils literal notranslate"><span class="pre">Blocking(void*)</span></code> / <code class="docutils literal notranslate"><span class="pre">NonBlocking(void*)</span></code> overloads;
the <code class="docutils literal notranslate"><span class="pre">Callback</span></code> and templated <code class="docutils literal notranslate"><span class="pre">data*</span></code> overloads should <em>not</em> be used. See below
for additional details.</p>
</div>
<div class="section" id="new">
<h3>New<a class="headerlink" href="#new" title="Permalink to this headline">¶</a></h3>
<p>Creates a new instance of the <code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code> object. The <code class="docutils literal notranslate"><span class="pre">New</span></code>
function has several overloads for the various optional parameters: skip the
optional parameter for that specific overload.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">New</span><span class="p">(</span><span class="n">napi_env</span> <span class="n">env</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">Function</span><span class="o">&amp;</span> <span class="n">callback</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">Object</span><span class="o">&amp;</span> <span class="n">resource</span><span class="p">,</span>
    <span class="n">ResourceString</span> <span class="n">resourceName</span><span class="p">,</span>
    <span class="kt">size_t</span> <span class="n">maxQueueSize</span><span class="p">,</span>
    <span class="kt">size_t</span> <span class="n">initialThreadCount</span><span class="p">,</span>
    <span class="n">ContextType</span><span class="o">*</span> <span class="n">context</span><span class="p">,</span>
    <span class="n">Finalizer</span> <span class="n">finalizeCallback</span><span class="p">,</span>
    <span class="n">FinalizerDataType</span><span class="o">*</span> <span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">env</span></code>: The <code class="docutils literal notranslate"><span class="pre">napi_env</span></code> environment in which to construct the
<code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code> object.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">callback</span></code>: The <code class="docutils literal notranslate"><span class="pre">Function</span></code> to call from another thread.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[optional]</span> <span class="pre">resource</span></code>: An object associated with the async work that will be
passed to possible async_hooks init hooks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resourceName</span></code>: A JavaScript string to provide an identifier for the kind of
resource that is being provided for diagnostic information exposed by the
async_hooks API.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">maxQueueSize</span></code>: Maximum size of the queue. <code class="docutils literal notranslate"><span class="pre">0</span></code> for no limit.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">initialThreadCount</span></code>: The initial number of threads, including the main
thread, which will be making use of this function.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[optional]</span> <span class="pre">context</span></code>: Data to attach to the resulting <code class="docutils literal notranslate"><span class="pre">ThreadSafeFunction</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[optional]</span> <span class="pre">finalizeCallback</span></code>: Function to call when the <code class="docutils literal notranslate"><span class="pre">ThreadSafeFunction</span></code>
is being destroyed.  This callback will be invoked on the main thread when the
thread-safe function is about to be destroyed. It receives the context and the
finalize data given during construction (if given), and provides an
opportunity for cleaning up after the threads e.g. by calling
<code class="docutils literal notranslate"><span class="pre">uv_thread_join()</span></code>. It is important that, aside from the main loop thread,
there be no threads left using the thread-safe function after the finalize
callback completes. Must implement <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">operator()(Env</span> <span class="pre">env,</span> <span class="pre">DataType*</span> <span class="pre">data,</span> <span class="pre">Context*</span> <span class="pre">hint)</span></code>, skipping <code class="docutils literal notranslate"><span class="pre">data</span></code> or <code class="docutils literal notranslate"><span class="pre">hint</span></code> if they are not provided.
Can be retreived via <code class="docutils literal notranslate"><span class="pre">GetContext()</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[optional]</span> <span class="pre">data</span></code>: Data to be passed to <code class="docutils literal notranslate"><span class="pre">finalizeCallback</span></code>.</p></li>
</ul>
<p>Returns a non-empty <code class="docutils literal notranslate"><span class="pre">Napi::ThreadSafeFunction</span></code> instance.</p>
</div>
<div class="section" id="acquire">
<h3>Acquire<a class="headerlink" href="#acquire" title="Permalink to this headline">¶</a></h3>
<p>Add a thread to this thread-safe function object, indicating that a new thread
will start making use of the thread-safe function.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">napi_status</span> <span class="n">Napi</span><span class="o">::</span><span class="n">ThreadSafeFunction</span><span class="o">::</span><span class="n">Acquire</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns one of:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">napi_ok</span></code>: The thread has successfully acquired the thread-safe function
for its use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">napi_closing</span></code>: The thread-safe function has been marked as closing via a
previous call to <code class="docutils literal notranslate"><span class="pre">Abort()</span></code>.</p></li>
</ul>
</div>
<div class="section" id="release">
<h3>Release<a class="headerlink" href="#release" title="Permalink to this headline">¶</a></h3>
<p>Indicate that an existing thread will stop making use of the thread-safe
function. A thread should call this API when it stops making use of this
thread-safe function. Using any thread-safe APIs after having called this API
has undefined results in the current thread, as it may have been destroyed.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">napi_status</span> <span class="n">Napi</span><span class="o">::</span><span class="n">ThreadSafeFunction</span><span class="o">::</span><span class="n">Release</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns one of:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">napi_ok</span></code>: The thread-safe function has been successfully released.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">napi_invalid_arg</span></code>: The thread-safe function’s thread-count is zero.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">napi_generic_failure</span></code>: A generic error occurred when attemping to release
the thread-safe function.</p></li>
</ul>
</div>
<div class="section" id="abort">
<h3>Abort<a class="headerlink" href="#abort" title="Permalink to this headline">¶</a></h3>
<p>“Abort” the thread-safe function. This will cause all subsequent APIs associated
with the thread-safe function except <code class="docutils literal notranslate"><span class="pre">Release()</span></code> to return <code class="docutils literal notranslate"><span class="pre">napi_closing</span></code> even
before its reference count reaches zero. In particular, <code class="docutils literal notranslate"><span class="pre">BlockingCall</span></code> and
<code class="docutils literal notranslate"><span class="pre">NonBlockingCall()</span></code> will return <code class="docutils literal notranslate"><span class="pre">napi_closing</span></code>, thus informing the threads that
it is no longer possible to make asynchronous calls to the thread-safe function.
This can be used as a criterion for terminating the thread. Upon receiving a
return value of <code class="docutils literal notranslate"><span class="pre">napi_closing</span></code> from a thread-safe function call a thread must
make no further use of the thread-safe function because it is no longer
guaranteed to be allocated.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">napi_status</span> <span class="n">Napi</span><span class="o">::</span><span class="n">ThreadSafeFunction</span><span class="o">::</span><span class="n">Abort</span><span class="p">()</span>
</pre></div>
</div>
<p>Returns one of:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">napi_ok</span></code>: The thread-safe function has been successfully aborted.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">napi_invalid_arg</span></code>: The thread-safe function’s thread-count is zero.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">napi_generic_failure</span></code>: A generic error occurred when attemping to abort
the thread-safe function.</p></li>
</ul>
</div>
<div class="section" id="blockingcall-nonblockingcall">
<h3>BlockingCall / NonBlockingCall<a class="headerlink" href="#blockingcall-nonblockingcall" title="Permalink to this headline">¶</a></h3>
<p>Calls the Javascript function in either a blocking or non-blocking fashion.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BlockingCall()</span></code>: the API blocks until space becomes available in the queue.
Will never block if the thread-safe function was created with a maximum queue
size of <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NonBlockingCall()</span></code>: will return <code class="docutils literal notranslate"><span class="pre">napi_queue_full</span></code> if the queue was full,
preventing data from being successfully added to the queue.</p></li>
</ul>
<p>There are several overloaded implementations of <code class="docutils literal notranslate"><span class="pre">BlockingCall()</span></code> and
<code class="docutils literal notranslate"><span class="pre">NonBlockingCall()</span></code> for use with optional parameters: skip the optional
parameter for that specific overload.</p>
<p><strong>These specific function overloads should only be used on a <code class="docutils literal notranslate"><span class="pre">ThreadSafeFunction</span></code>
created via <code class="docutils literal notranslate"><span class="pre">ThreadSafeFunction::New</span></code>.</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">napi_status</span> <span class="n">Napi</span><span class="o">::</span><span class="n">ThreadSafeFunction</span><span class="o">::</span><span class="n">BlockingCall</span><span class="p">(</span><span class="n">DataType</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">Callback</span> <span class="n">callback</span><span class="p">)</span> <span class="k">const</span>

<span class="n">napi_status</span> <span class="n">Napi</span><span class="o">::</span><span class="n">ThreadSafeFunction</span><span class="o">::</span><span class="n">NonBlockingCall</span><span class="p">(</span><span class="n">DataType</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">Callback</span> <span class="n">callback</span><span class="p">)</span> <span class="k">const</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">[optional]</span> <span class="pre">data</span></code>: Data to pass to <code class="docutils literal notranslate"><span class="pre">callback</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[optional]</span> <span class="pre">callback</span></code>: C++ function that is invoked on the main thread. The
callback receives the <code class="docutils literal notranslate"><span class="pre">ThreadSafeFunction</span></code>’s JavaScript callback function to
call as an <code class="docutils literal notranslate"><span class="pre">Napi::Function</span></code> in its parameters and the <code class="docutils literal notranslate"><span class="pre">DataType*</span></code> data pointer
(if provided). Must implement <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">operator()(Napi::Env</span> <span class="pre">env,</span> <span class="pre">Function</span> <span class="pre">jsCallback,</span> <span class="pre">DataType*</span> <span class="pre">data)</span></code>, skipping <code class="docutils literal notranslate"><span class="pre">data</span></code> if not provided. It is not
necessary to call into JavaScript via <code class="docutils literal notranslate"><span class="pre">MakeCallback()</span></code> because N-API runs
<code class="docutils literal notranslate"><span class="pre">callback</span></code> in a context appropriate for callbacks.</p></li>
</ul>
<p><strong>These specific function overloads should only be used on a <code class="docutils literal notranslate"><span class="pre">ThreadSafeFunction</span></code>
created via <code class="docutils literal notranslate"><span class="pre">ThreadSafeFunction(napi_threadsafe_function)</span></code>.</strong></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">napi_status</span> <span class="n">Napi</span><span class="o">::</span><span class="n">ThreadSafeFunction</span><span class="o">::</span><span class="n">BlockingCall</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span> <span class="k">const</span>

<span class="n">napi_status</span> <span class="n">Napi</span><span class="o">::</span><span class="n">ThreadSafeFunction</span><span class="o">::</span><span class="n">NonBlockingCall</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span> <span class="k">const</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code>: Data to pass to <code class="docutils literal notranslate"><span class="pre">call_js_cb</span></code> specified when creating the thread-safe
function via <code class="docutils literal notranslate"><span class="pre">napi_create_threadsafe_function</span></code>.</p></li>
</ul>
<p>Returns one of:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">napi_ok</span></code>: The call was successfully added to the queue.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">napi_queue_full</span></code>: The queue was full when trying to call in a non-blocking
method.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">napi_closing</span></code>: The thread-safe function is aborted and cannot accept more
calls.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">napi_invalid_arg</span></code>: The thread-safe function is closed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">napi_generic_failure</span></code>: A generic error occurred when attemping to add to the
queue.</p></li>
</ul>
</div>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;napi.h&gt;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="nn">Napi</span><span class="p">;</span>

<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">nativeThread</span><span class="p">;</span>
<span class="n">ThreadSafeFunction</span> <span class="n">tsfn</span><span class="p">;</span>

<span class="n">Value</span> <span class="nf">Start</span><span class="p">(</span> <span class="k">const</span> <span class="n">CallbackInfo</span><span class="o">&amp;</span> <span class="n">info</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">Napi</span><span class="o">::</span><span class="n">Env</span> <span class="n">env</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">Env</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">info</span><span class="p">.</span><span class="n">Length</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">throw</span> <span class="n">TypeError</span><span class="o">::</span><span class="n">New</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="s">&quot;Expected two arguments&quot;</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">IsFunction</span><span class="p">()</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">throw</span> <span class="n">TypeError</span><span class="o">::</span><span class="n">New</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="s">&quot;Expected first arg to be function&quot;</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">IsNumber</span><span class="p">()</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">throw</span> <span class="n">TypeError</span><span class="o">::</span><span class="n">New</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="s">&quot;Expected second arg to be number&quot;</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">As</span><span class="o">&lt;</span><span class="n">Number</span><span class="o">&gt;</span><span class="p">().</span><span class="n">Int32Value</span><span class="p">();</span>

  <span class="c1">// Create a ThreadSafeFunction</span>
  <span class="n">tsfn</span> <span class="o">=</span> <span class="n">ThreadSafeFunction</span><span class="o">::</span><span class="n">New</span><span class="p">(</span>
      <span class="n">env</span><span class="p">,</span>
      <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">As</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(),</span>  <span class="c1">// JavaScript function called asynchronously</span>
      <span class="s">&quot;Resource Name&quot;</span><span class="p">,</span>         <span class="c1">// Name</span>
      <span class="mi">0</span><span class="p">,</span>                       <span class="c1">// Unlimited queue</span>
      <span class="mi">1</span><span class="p">,</span>                       <span class="c1">// Only one thread will use this initially</span>
      <span class="p">[](</span> <span class="n">Napi</span><span class="o">::</span><span class="n">Env</span> <span class="p">)</span> <span class="p">{</span>        <span class="c1">// Finalizer used to clean threads up</span>
        <span class="n">nativeThread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
      <span class="p">}</span> <span class="p">);</span>

  <span class="c1">// Create a native thread</span>
  <span class="n">nativeThread</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span> <span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">callback</span> <span class="o">=</span> <span class="p">[](</span> <span class="n">Napi</span><span class="o">::</span><span class="n">Env</span> <span class="n">env</span><span class="p">,</span> <span class="n">Function</span> <span class="n">jsCallback</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">value</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Transform native data into JS data, passing it to the provided </span>
      <span class="c1">// `jsCallback` -- the TSFN&#39;s JavaScript function.</span>
      <span class="n">jsCallback</span><span class="p">.</span><span class="n">Call</span><span class="p">(</span> <span class="p">{</span><span class="n">Number</span><span class="o">::</span><span class="n">New</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span> <span class="p">)}</span> <span class="p">);</span>
      
      <span class="c1">// We&#39;re finished with the data.</span>
      <span class="k">delete</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Create new data</span>
      <span class="kt">int</span><span class="o">*</span> <span class="n">value</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">(</span> <span class="n">clock</span><span class="p">()</span> <span class="p">);</span>

      <span class="c1">// Perform a blocking call</span>
      <span class="n">napi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">tsfn</span><span class="p">.</span><span class="n">BlockingCall</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="n">callback</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">napi_ok</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="c1">// Handle error</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Release the thread-safe function</span>
    <span class="n">tsfn</span><span class="p">.</span><span class="n">Release</span><span class="p">();</span>
  <span class="p">}</span> <span class="p">);</span>

  <span class="k">return</span> <span class="n">Boolean</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">Napi</span><span class="o">::</span><span class="n">Object</span> <span class="nf">Init</span><span class="p">(</span> <span class="n">Napi</span><span class="o">::</span><span class="n">Env</span> <span class="n">env</span><span class="p">,</span> <span class="n">Object</span> <span class="n">exports</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">exports</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span> <span class="s">&quot;start&quot;</span><span class="p">,</span> <span class="n">Function</span><span class="o">::</span><span class="n">New</span><span class="p">(</span> <span class="n">env</span><span class="p">,</span> <span class="n">Start</span> <span class="p">)</span> <span class="p">);</span>
  <span class="k">return</span> <span class="n">exports</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NODE_API_MODULE</span><span class="p">(</span> <span class="n">clock</span><span class="p">,</span> <span class="n">Init</span> <span class="p">)</span>
</pre></div>
</div>
<p>The above code can be used from JavaScript as follows:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span> <span class="p">{</span> <span class="nx">start</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bindings&#39;</span><span class="p">)(</span><span class="s1">&#39;clock&#39;</span><span class="p">);</span>

<span class="nx">start</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;JavaScript callback called with arguments&quot;</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">arguments</span><span class="p">));</span>
<span class="p">},</span> <span class="mf">5</span><span class="p">);</span>
</pre></div>
</div>
<p>When executed, the output will show the value of <code class="docutils literal notranslate"><span class="pre">clock()</span></code> five times at one
second intervals:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">JavaScript</span> <span class="n">callback</span> <span class="n">called</span> <span class="k">with</span> <span class="n">arguments</span> <span class="p">[</span> <span class="mi">84745</span> <span class="p">]</span>
<span class="n">JavaScript</span> <span class="n">callback</span> <span class="n">called</span> <span class="k">with</span> <span class="n">arguments</span> <span class="p">[</span> <span class="mi">103211</span> <span class="p">]</span>
<span class="n">JavaScript</span> <span class="n">callback</span> <span class="n">called</span> <span class="k">with</span> <span class="n">arguments</span> <span class="p">[</span> <span class="mi">104516</span> <span class="p">]</span>
<span class="n">JavaScript</span> <span class="n">callback</span> <span class="n">called</span> <span class="k">with</span> <span class="n">arguments</span> <span class="p">[</span> <span class="mi">105104</span> <span class="p">]</span>
<span class="n">JavaScript</span> <span class="n">callback</span> <span class="n">called</span> <span class="k">with</span> <span class="n">arguments</span> <span class="p">[</span> <span class="mi">105691</span> <span class="p">]</span>
</pre></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./nbs/z-repo_Solidity/Faucet/node_modules/node-addon-api/doc"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Dave Friedman<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../../../../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>